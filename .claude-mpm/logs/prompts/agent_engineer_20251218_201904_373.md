---
timestamp: 2025-12-18T20:19:04.373517+00:00
type: agent_engineer
metadata: {"agent_type": "engineer", "agent_id": "engineer_bc691194-b92e-4217-8fbe-378faa708438", "session_id": "bc691194-b92e-4217-8fbe-378faa708438", "delegation_context": {"description": "Add activity duration inference", "timestamp": "2025-12-18T20:19:04.370407+00:00"}}
---


AGENT MEMORY - PROJECT-SPECIFIC KNOWLEDGE:
# Agent Memory: engineer
<!-- Last Updated: 2025-12-17T23:24:44.617242+00:00Z -->



INSTRUCTIONS: Review your memory above before proceeding. Apply learned patterns and avoid known mistakes.


Add standard duration inference for activities to prevent overlapping transfers.

**Problem**: A transfer ends at 3:00 PM but the dinner it connects to starts at 2:30 PM - the transfer overlaps with the activity it's connecting to!

This happens because:
1. Activities often only have a `startDatetime` but no `endDatetime`
2. The gap-filler doesn't know when activities end
3. Transfers get scheduled based on raw times without considering activity duration

**Solution**: Infer standard durations based on activity type/name.

**Add to `src/services/segment-continuity.service.ts`** (or create `src/services/duration-inference.service.ts`):

```typescript
interface InferredDuration {
  hours: number;
  confidence: 'high' | 'medium' | 'low';
}

function inferActivityDuration(segment: Segment): InferredDuration {
  const name = (segment.description || segment.location?.name || '').toLowerCase();
  
  // Meals
  if (name.includes('breakfast')) return { hours: 1, confidence: 'high' };
  if (name.includes('brunch')) return { hours: 1.5, confidence: 'high' };
  if (name.includes('lunch')) return { hours: 1.5, confidence: 'high' };
  if (name.includes('dinner')) return { hours: 2, confidence: 'high' };
  if (name.includes('cocktail')) return { hours: 1.5, confidence: 'medium' };
  
  // Entertainment
  if (name.includes('show') || name.includes('broadway') || name.includes('theatre')) 
    return { hours: 2.5, confidence: 'high' };
  if (name.includes('concert')) return { hours: 2.5, confidence: 'high' };
  if (name.includes('movie') || name.includes('film')) return { hours: 2, confidence: 'high' };
  
  // Activities
  if (name.includes('tour')) return { hours: 3, confidence: 'medium' };
  if (name.includes('museum')) return { hours: 2, confidence: 'medium' };
  if (name.includes('spa')) return { hours: 2, confidence: 'medium' };
  if (name.includes('golf')) return { hours: 4, confidence: 'medium' };
  
  // Default for unknown activities
  return { hours: 2, confidence: 'low' };
}
```

**Use in gap-filling**:
1. When calculating gaps, use inferred end time if `endDatetime` is missing
2. Before creating a transfer, verify it doesn't overlap with source/destination activities
3. If transfer would overlap, adjust transfer times or skip

**Validation rule**:
```typescript
// Don't create transfer if it would end after destination starts
if (transferEndTime > destinationStartTime) {
  // Adjust or skip
}

// Don't create transfer if it would start before source ends
const sourceEndTime = source.endDatetime || 
  new Date(source.startDatetime.getTime() + inferActivityDuration(source).hours * 3600000);
if (transferStartTime < sourceEndTime) {
  // Adjust or skip
}
```

**Also update schema normalizer** to auto-set `endDatetime` based on inferred duration when missing.