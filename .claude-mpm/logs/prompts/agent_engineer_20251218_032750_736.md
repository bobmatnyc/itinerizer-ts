---
timestamp: 2025-12-18T03:27:50.736719+00:00
type: agent_engineer
metadata: {"agent_type": "engineer", "agent_id": "engineer_bc691194-b92e-4217-8fbe-378faa708438", "session_id": "bc691194-b92e-4217-8fbe-378faa708438", "delegation_context": {"description": "Implement segment continuity", "timestamp": "2025-12-18T03:27:50.735781+00:00"}}
---


AGENT MEMORY - PROJECT-SPECIFIC KNOWLEDGE:
# Agent Memory: engineer
<!-- Last Updated: 2025-12-17T23:24:44.617242+00:00Z -->



INSTRUCTIONS: Review your memory above before proceeding. Apply learned patterns and avoid known mistakes.


Implement semantic segment validation and LLM prompt enhancement for the itinerizer-ts project.

**Context**: The user wants to detect geographic discontinuities between segments and have the LLM find missing transportation in source documents.

**Examples from user**:
1. Flight lands at JFK, next segment is hotel "The Manhattan Grand" in Manhattan - MISSING TRANSFER from JFK to hotel
2. Flight lands at PHL (Philadelphia), next segment starts at Milan Malpensa Airport - MISSING INTERNATIONAL FLIGHT from PHL to Milan

**Tasks**:

### 1. Create Geographic Continuity Validator
Create `src/services/segment-continuity.service.ts`:
- `getStartLocation(segment)` - Returns start location for any segment type
- `getEndLocation(segment)` - Returns end location for any segment type  
- `detectLocationGaps(segments: Segment[])` - Find where end location â‰  next start location
- `classifyGap(endLoc, startLoc)` - Determine if gap needs TRANSFER (same city) or FLIGHT (different city/country)

### 2. Enhance LLM System Prompt
Update `src/services/llm.service.ts` to add instructions for the LLM:
- After parsing all explicit segments, check for geographic continuity
- If segment N ends at location A and segment N+1 starts at location B:
  - Search the source document for transportation between A and B
  - If found, add as FLIGHT or TRANSFER segment
  - If not found in document, flag as "INFERRED" transfer/flight with estimated times
- Pay special attention to:
  - Airport arrivals followed by hotel check-ins (need ground transfer)
  - International gaps (one city/country to another without flight)

### 3. Add Inferred Segment Marker
Add to segment types:
```typescript
interface BaseSegment {
  // ... existing fields
  inferred?: boolean;  // True if segment was auto-generated, not from source
  inferredReason?: string;  // e.g., "Geographic gap between JFK and Manhattan Grand"
}
```

### 4. Create Post-Import Validation
Create function to run after LLM parsing that:
- Sorts segments chronologically
- Runs `detectLocationGaps()` 
- Reports any remaining gaps that weren't filled
- Optionally auto-generates placeholder segments for gaps

**Files to read first**:
- `src/services/llm.service.ts` - Current LLM prompts
- `src/domain/types/segment.ts` - Segment types
- `src/services/document-import.service.ts` - Import pipeline

**Files to create/modify**:
- Create: `src/services/segment-continuity.service.ts`
- Modify: `src/services/llm.service.ts` (enhance prompts)
- Modify: `src/domain/types/segment.ts` (add inferred field)
- Modify: `src/domain/schemas/segment.schema.ts` (add to Zod schema)