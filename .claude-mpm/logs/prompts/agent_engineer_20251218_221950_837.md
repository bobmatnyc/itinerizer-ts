---
timestamp: 2025-12-18T22:19:50.837500+00:00
type: agent_engineer
metadata: {"agent_type": "engineer", "agent_id": "engineer_bc691194-b92e-4217-8fbe-378faa708438", "session_id": "bc691194-b92e-4217-8fbe-378faa708438", "delegation_context": {"description": "Create re-geocoding script for itineraries", "timestamp": "2025-12-18T22:19:50.836308+00:00"}}
---


AGENT MEMORY - PROJECT-SPECIFIC KNOWLEDGE:
# Agent Memory: engineer
<!-- Last Updated: 2025-12-17T23:24:44.617242+00:00Z -->



INSTRUCTIONS: Review your memory above before proceeding. Apply learned patterns and avoid known mistakes.


Create a script to re-geocode all existing itineraries to add coordinates to their location fields.

## Context

- Itineraries are stored in `data/itineraries/*.json`
- The `GeocodingService` exists at `src/services/geocoding.service.ts`
- Locations are already part of segments (origin, destination, location, pickupLocation, dropoffLocation)
- The `Location` type already has a `coordinates?: Coordinates` property
- The document import service already does this in `geocodeItinerary()` method

## Task

Create a script `scripts/re-geocode-itineraries.ts` that:

1. Loads all itineraries from `data/itineraries/`
2. For each itinerary, collects all unique locations from segments:
   - Flight: origin, destination
   - Hotel: location
   - Activity: location
   - Meeting: location
   - Transfer: pickupLocation, dropoffLocation
   - Custom: location (if present)

3. Builds queries using `geocodingService.buildLocationQuery(location)`
4. Batch geocodes all unique locations (with rate limiting - 1/sec)
5. Updates each segment's location with coordinates
6. Saves the updated itinerary

## Requirements

1. Skip locations that already have coordinates
2. Show progress (e.g., "Processing itinerary 1/10: Trip to Paris")
3. Show geocoding results (e.g., "  ✓ JFK Airport → 40.6413, -73.7781")
4. Handle geocoding failures gracefully (log warning, continue)
5. Summary at end (e.g., "Geocoded 45 locations across 10 itineraries")

## Example Output

```
Re-geocoding itineraries...

Processing 1/10: Family Adventure in Moab
  Found 8 unique locations
  ✓ JFK Airport → 40.6413, -73.7781
  ✓ Salt Lake City International Airport → 40.7899, -111.9791
  ✓ Kimpton Hotel Monaco Salt Lake → 40.7608, -111.8910
  ⚠ Hoodoo Moab → No results
  ...
  Updated 7/8 locations

Processing 2/10: NYC to Paris...
...

Summary:
  Itineraries processed: 10
  Locations geocoded: 45/52
  Locations skipped (already geocoded): 12
  Locations failed: 7
```

## Implementation Notes

Use the existing services:
```typescript
import { GeocodingService } from '../src/services/geocoding.service.js';
import { JsonItineraryStorage } from '../src/storage/json-storage.js';
```

Run with:
```bash
npx tsx scripts/re-geocode-itineraries.ts
```