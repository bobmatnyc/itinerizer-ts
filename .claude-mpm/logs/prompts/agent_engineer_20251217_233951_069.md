---
timestamp: 2025-12-17T23:39:51.069874+00:00
type: agent_engineer
metadata: {"agent_type": "engineer", "agent_id": "engineer_bc691194-b92e-4217-8fbe-378faa708438", "session_id": "bc691194-b92e-4217-8fbe-378faa708438", "delegation_context": {"description": "Implement core and domain types", "timestamp": "2025-12-17T23:39:51.069286+00:00"}}
---


AGENT MEMORY - PROJECT-SPECIFIC KNOWLEDGE:
# Agent Memory: engineer
<!-- Last Updated: 2025-12-17T23:24:44.617242+00:00Z -->



INSTRUCTIONS: Review your memory above before proceeding. Apply learned patterns and avoid known mistakes.


Implement core utilities and domain types for the itinerizer-ts CLI at /Users/masa/Projects/itinerizer-ts.

## Task 1: Core Utilities (src/core/)

### 1.1 result.ts - Result type for error handling
```typescript
// Discriminated union Result type
export type Result<T, E = Error> =
  | { success: true; value: T }
  | { success: false; error: E };

// Helper constructors
export const ok = <T>(value: T): Result<T, never> => ({ success: true, value });
export const err = <E>(error: E): Result<never, E> => ({ success: false, error });

// Utility functions
export function map<T, U, E>(result: Result<T, E>, fn: (value: T) => U): Result<U, E>;
export function flatMap<T, U, E>(result: Result<T, E>, fn: (value: T) => Result<U, E>): Result<U, E>;
export function unwrapOr<T, E>(result: Result<T, E>, defaultValue: T): T;
export function isOk<T, E>(result: Result<T, E>): result is { success: true; value: T };
export function isErr<T, E>(result: Result<T, E>): result is { success: false; error: E };
```

### 1.2 errors.ts - Domain error definitions
```typescript
// Base error type
export interface DomainError {
  code: string;
  message: string;
  details?: Record<string, unknown>;
}

// Specific error types
export type StorageError = DomainError & {
  code: 'NOT_FOUND' | 'WRITE_ERROR' | 'READ_ERROR' | 'VALIDATION_ERROR';
};

export type ValidationError = DomainError & {
  code: 'INVALID_DATA' | 'MISSING_FIELD' | 'CONSTRAINT_VIOLATION';
  field?: string;
};

export type DependencyError = DomainError & {
  code: 'CIRCULAR_DEPENDENCY' | 'MISSING_DEPENDENCY' | 'ADJUSTMENT_FAILED';
  affectedSegments?: string[];
};

// Error factory functions
export function createStorageError(code: StorageError['code'], message: string, details?: Record<string, unknown>): StorageError;
export function createValidationError(code: ValidationError['code'], message: string, field?: string): ValidationError;
export function createDependencyError(code: DependencyError['code'], message: string, affectedSegments?: string[]): DependencyError;
```

### 1.3 id-generator.ts - UUID utilities
```typescript
// Use Node's crypto for UUID generation
import { randomUUID } from 'node:crypto';

export function generateId(): string;
export function isValidUUID(value: string): boolean;
```

## Task 2: Domain Types (src/domain/types/)

### 2.1 branded.ts - Branded ID types
```typescript
// Branded type pattern for type-safe IDs
declare const brand: unique symbol;
type Brand<T, B> = T & { readonly [brand]: B };

export type ItineraryId = Brand<string, 'ItineraryId'>;
export type SegmentId = Brand<string, 'SegmentId'>;
export type TravelerId = Brand<string, 'TravelerId'>;

// Constructors (validate UUID format)
export function createItineraryId(value: string): ItineraryId;
export function createSegmentId(value: string): SegmentId;
export function createTravelerId(value: string): TravelerId;

// Generators (create new UUIDs)
export function generateItineraryId(): ItineraryId;
export function generateSegmentId(): SegmentId;
export function generateTravelerId(): TravelerId;
```

### 2.2 common.ts - Enums and shared types
```typescript
// Itinerary status
export const ItineraryStatus = {
  DRAFT: 'DRAFT',
  PLANNED: 'PLANNED', 
  CONFIRMED: 'CONFIRMED',
  IN_PROGRESS: 'IN_PROGRESS',
  COMPLETED: 'COMPLETED',
  CANCELLED: 'CANCELLED',
} as const;
export type ItineraryStatus = typeof ItineraryStatus[keyof typeof ItineraryStatus];

// Trip type
export const TripType = {
  LEISURE: 'LEISURE',
  BUSINESS: 'BUSINESS',
  MIXED: 'MIXED',
} as const;
export type TripType = typeof TripType[keyof typeof TripType];

// Segment type discriminator
export const SegmentType = {
  FLIGHT: 'FLIGHT',
  HOTEL: 'HOTEL',
  MEETING: 'MEETING',
  ACTIVITY: 'ACTIVITY',
  TRANSFER: 'TRANSFER',
  CUSTOM: 'CUSTOM',
} as const;
export type SegmentType = typeof SegmentType[keyof typeof SegmentType];

// Segment status
export const SegmentStatus = {
  TENTATIVE: 'TENTATIVE',
  CONFIRMED: 'CONFIRMED',
  WAITLISTED: 'WAITLISTED',
  CANCELLED: 'CANCELLED',
  COMPLETED: 'COMPLETED',
} as const;
export type SegmentStatus = typeof SegmentStatus[keyof typeof SegmentStatus];

// Traveler type
export const TravelerType = {
  ADULT: 'ADULT',
  CHILD: 'CHILD',
  INFANT: 'INFANT',
  SENIOR: 'SENIOR',
} as const;
export type TravelerType = typeof TravelerType[keyof typeof TravelerType];

// Cabin class
export const CabinClass = {
  ECONOMY: 'ECONOMY',
  PREMIUM_ECONOMY: 'PREMIUM_ECONOMY',
  BUSINESS: 'BUSINESS',
  FIRST: 'FIRST',
} as const;
export type CabinClass = typeof CabinClass[keyof typeof CabinClass];

// Transfer type
export const TransferType = {
  TAXI: 'TAXI',
  SHUTTLE: 'SHUTTLE',
  PRIVATE: 'PRIVATE',
  PUBLIC: 'PUBLIC',
  RIDE_SHARE: 'RIDE_SHARE',
} as const;
export type TransferType = typeof TransferType[keyof typeof TransferType];

// Board basis for hotels
export const BoardBasis = {
  ROOM_ONLY: 'ROOM_ONLY',
  BED_BREAKFAST: 'BED_BREAKFAST',
  HALF_BOARD: 'HALF_BOARD',
  FULL_BOARD: 'FULL_BOARD',
  ALL_INCLUSIVE: 'ALL_INCLUSIVE',
} as const;
export type BoardBasis = typeof BoardBasis[keyof typeof BoardBasis];
```

### 2.3 money.ts - Money type
```typescript
export interface Money {
  amount: number;  // Store as cents/smallest unit for precision
  currency: string;  // ISO 4217 (3-letter code)
}

// Helper functions
export function formatMoney(money: Money): string;
export function addMoney(a: Money, b: Money): Money;  // Throws if different currencies
export function createMoney(amount: number, currency: string): Money;
```

### 2.4 location.ts - Location types
```typescript
export interface Coordinates {
  latitude: number;  // -90 to 90
  longitude: number;  // -180 to 180
}

export interface Address {
  street?: string;
  city?: string;
  state?: string;
  postalCode?: string;
  country: string;  // ISO 2-letter code
}

export interface Location {
  name: string;
  code?: string;  // Airport/city code (IATA)
  address?: Address;
  coordinates?: Coordinates;
  timezone?: string;  // IANA timezone
}

export interface Company {
  name: string;
  code?: string;  // Airline/company code
  website?: string;
}
```

### 2.5 traveler.ts - Traveler types
```typescript
import type { TravelerId } from './branded';
import type { TravelerType } from './common';

export interface LoyaltyProgram {
  carrier: string;  // Airline/company code
  number: string;  // Membership number
  tier?: string;  // Membership tier
}

export interface TravelPreferences {
  seatPreference?: 'AISLE' | 'WINDOW' | 'MIDDLE';
  mealPreference?: string;
  hotelChainPreference?: string[];
  accessibility?: string[];
}

export interface Traveler {
  id: TravelerId;
  type: TravelerType;
  firstName: string;
  lastName: string;
  middleName?: string;
  email?: string;
  phone?: string;
  dateOfBirth?: Date;
  passportNumber?: string;
  passportExpiry?: Date;
  passportCountry?: string;  // ISO 2-letter
  loyaltyPrograms: LoyaltyProgram[];
  specialRequests: string[];
  metadata: Record<string, unknown>;
}
```

### 2.6 segment.ts - Segment discriminated union (THIS IS CRITICAL)
```typescript
import type { SegmentId, TravelerId } from './branded';
import type { SegmentType, SegmentStatus, CabinClass, TransferType, BoardBasis } from './common';
import type { Location, Address, Company } from './location';
import type { Money } from './money';

// Base segment fields (shared by all segment types)
interface BaseSegment {
  id: SegmentId;
  status: SegmentStatus;
  startDatetime: Date;
  endDatetime: Date;
  travelerIds: TravelerId[];
  confirmationNumber?: string;
  bookingReference?: string;
  provider?: Company;
  price?: Money;
  taxes?: Money;
  fees?: Money;
  totalPrice?: Money;
  notes?: string;
  metadata: Record<string, unknown>;
  dependsOn?: SegmentId[];  // Explicit dependencies
}

// Flight segment
export interface FlightSegment extends BaseSegment {
  type: typeof SegmentType.FLIGHT;
  airline: Company;
  flightNumber: string;
  origin: Location;
  destination: Location;
  departureTerminal?: string;
  arrivalTerminal?: string;
  aircraft?: string;
  cabinClass?: CabinClass;
  bookingClass?: string;
  seatAssignments?: Record<string, string>;  // TravelerId -> seat
  durationMinutes?: number;
  baggageAllowance?: string;
}

// Hotel segment
export interface HotelSegment extends BaseSegment {
  type: typeof SegmentType.HOTEL;
  property: Company;
  location: Location;
  checkInDate: Date;
  checkOutDate: Date;
  checkInTime?: string;  // "15:00"
  checkOutTime?: string;  // "11:00"
  roomType?: string;
  roomCount: number;
  boardBasis?: BoardBasis;
  cancellationPolicy?: string;
  amenities: string[];
}

// Meeting segment
export interface MeetingSegment extends BaseSegment {
  type: typeof SegmentType.MEETING;
  title: string;
  location: Location;
  organizer?: string;
  attendees: string[];
  agenda?: string;
  meetingUrl?: string;
  dialIn?: string;
}

// Activity segment
export interface ActivitySegment extends BaseSegment {
  type: typeof SegmentType.ACTIVITY;
  name: string;
  description?: string;
  location: Location;
  category?: string;
  voucherNumber?: string;
}

// Transfer segment
export interface TransferSegment extends BaseSegment {
  type: typeof SegmentType.TRANSFER;
  transferType: TransferType;
  pickupLocation: Location;
  dropoffLocation: Location;
  vehicleDetails?: string;
  driverName?: string;
  driverPhone?: string;
}

// Custom segment
export interface CustomSegment extends BaseSegment {
  type: typeof SegmentType.CUSTOM;
  title: string;
  description?: string;
  location?: Location;
  customData: Record<string, unknown>;
}

// Discriminated union - THE MAIN TYPE
export type Segment =
  | FlightSegment
  | HotelSegment
  | MeetingSegment
  | ActivitySegment
  | TransferSegment
  | CustomSegment;

// Type guards
export function isFlightSegment(segment: Segment): segment is FlightSegment;
export function isHotelSegment(segment: Segment): segment is HotelSegment;
export function isMeetingSegment(segment: Segment): segment is MeetingSegment;
export function isActivitySegment(segment: Segment): segment is ActivitySegment;
export function isTransferSegment(segment: Segment): segment is TransferSegment;
export function isCustomSegment(segment: Segment): segment is CustomSegment;
```

### 2.7 itinerary.ts - Main Itinerary interface
```typescript
import type { ItineraryId, TravelerId } from './branded';
import type { ItineraryStatus, TripType } from './common';
import type { Segment } from './segment';
import type { Traveler, TravelPreferences } from './traveler';
import type { Location } from './location';
import type { Money } from './money';

export interface Itinerary {
  id: ItineraryId;
  version: number;
  createdAt: Date;
  updatedAt: Date;
  title: string;
  description?: string;
  status: ItineraryStatus;
  startDate: Date;
  endDate: Date;
  origin?: Location;
  destinations: Location[];
  travelers: Traveler[];
  primaryTravelerId?: TravelerId;
  createdBy?: string;
  segments: Segment[];
  totalPrice?: Money;
  currency?: string;  // ISO 4217
  tripType?: TripType;
  costCenter?: string;
  projectCode?: string;
  preferences?: TravelPreferences;
  tags: string[];
  metadata: Record<string, unknown>;
}
```

### 2.8 index.ts - Re-export all types
Create a clean index.ts that re-exports everything for easy imports.

## Requirements:
- All files must pass Biome lint
- All files must pass TypeScript strict mode
- Add JSDoc comments for public functions
- Keep files under 300 lines each

After implementation, run:
- `npm run lint` to verify linting
- `npm run typecheck` to verify types
- `npm run build` to verify build

Return the list of files created.