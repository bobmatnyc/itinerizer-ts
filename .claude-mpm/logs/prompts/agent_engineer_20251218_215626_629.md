---
timestamp: 2025-12-18T21:56:26.629725+00:00
type: agent_engineer
metadata: {"agent_type": "engineer", "agent_id": "engineer_bc691194-b92e-4217-8fbe-378faa708438", "session_id": "bc691194-b92e-4217-8fbe-378faa708438", "delegation_context": {"description": "Design Trip Designer Agent architecture", "timestamp": "2025-12-18T21:56:26.628288+00:00"}}
---


AGENT MEMORY - PROJECT-SPECIFIC KNOWLEDGE:
# Agent Memory: engineer
<!-- Last Updated: 2025-12-17T23:24:44.617242+00:00Z -->



INSTRUCTIONS: Review your memory above before proceeding. Apply learned patterns and avoid known mistakes.


Design and implement the Trip Designer Agent architecture for the Itinerizer project.

## Context

We're building a Trip Designer Agent that helps users plan trips through conversation. It must:
1. Use OpenRouter with Claude 3.5 Sonnet (or GPT-4o) with web search
2. Interact with itineraries through structured tool calls
3. Support session-based conversations with auto-compaction
4. Return structured questions for UI rendering
5. Update the itinerary JSON in real-time

## Existing Services to Use as Tools

The agent should use these existing services via tool calling:

```typescript
// SegmentService (src/services/segment.service.ts)
- add(itineraryId, segment) - Add a new segment
- update(itineraryId, segmentId, updates) - Update a segment  
- delete(itineraryId, segmentId) - Delete a segment
- get(itineraryId, segmentId) - Get a specific segment
- reorder(itineraryId, segmentIds) - Reorder segments

// DependencyService (src/services/dependency.service.ts)
- adjustDependentSegments(segments, segmentId, timeDeltaMs) - Move with cascade

// ItineraryService (src/services/itinerary.service.ts)
- get(id) - Get itinerary
- update(id, updates) - Update itinerary metadata
```

## Requirements

### 1. Tool Definitions
Create OpenRouter-compatible tool definitions for:
- `add_flight` - Add a flight segment
- `add_hotel` - Add a hotel/accommodation
- `add_activity` - Add an activity/tour
- `add_transfer` - Add a transfer between locations
- `add_meeting` - Add a meeting
- `update_segment` - Modify an existing segment
- `delete_segment` - Remove a segment
- `move_segment` - Move a segment in time (adjusts dependents)
- `reorder_segments` - Change segment order
- `get_itinerary` - Get current itinerary state
- `search_web` - Search for travel information (OpenRouter's :online)
- `search_flights` - Search flight prices (SERP API)
- `search_hotels` - Search hotel prices (SERP API)
- `search_transfers` - Search transfer options (Rome2Rio or SERP)

### 2. Session Management
Design a session structure that supports:
- Conversation history
- Extracted user preferences (trip profile)
- Current itinerary reference
- Auto-compaction when context exceeds threshold

```typescript
interface TripDesignerSession {
  id: string;
  itineraryId: ItineraryId;
  messages: Message[];
  tripProfile: TripProfile;
  createdAt: Date;
  lastActiveAt: Date;
}

interface TripProfile {
  travelers: { count: number; ages?: number[]; relationships?: string };
  budget?: { total?: number; currency?: string; flexibility?: 'strict' | 'flexible' };
  travelStyle?: string[];
  accommodationPreference?: string;
  pacePreference?: 'packed' | 'balanced' | 'leisurely';
  dietaryRestrictions?: string[];
  mobilityNeeds?: string[];
  interests?: string[];
  mustSee?: string[];
  avoidances?: string[];
}
```

### 3. Structured Questions
When the agent needs user input with specific options, return a structured response:

```typescript
interface StructuredQuestion {
  type: 'single_choice' | 'multiple_choice' | 'scale' | 'date_range';
  question: string;
  options?: { id: string; label: string; description?: string }[];
  min?: number;
  max?: number;
  metadata?: Record<string, unknown>;
}

interface AgentResponse {
  message: string;
  structuredQuestions?: StructuredQuestion[];
  itineraryUpdated?: boolean;
  toolCallsMade?: string[];
}
```

### 4. OpenRouter Integration
Configure for Claude 3.5 Sonnet with web search:
- Model: `anthropic/claude-3.5-sonnet:online`
- Enable tool calling
- Stream responses for real-time updates

### 5. File Structure
Create these files:
- `src/services/trip-designer/trip-designer.service.ts` - Main agent service
- `src/services/trip-designer/tools.ts` - Tool definitions
- `src/services/trip-designer/session.ts` - Session management
- `src/services/trip-designer/prompts.ts` - System prompts
- `src/domain/types/trip-designer.ts` - Types

### 6. System Prompt
The Trip Designer should:
- Be a friendly, knowledgeable travel expert
- Ask discovery questions to understand preferences
- Proactively suggest options with pros/cons
- Use web search to validate information and get current data
- Update the itinerary as plans are made
- Present structured choices when appropriate

Create the architecture design document at `docs/architecture/trip-designer-agent.md` and implement the core types and service structure.

Focus on:
1. Clean tool definitions that map to existing services
2. Session management with compaction strategy
3. Structured question response format
4. Integration points for OpenRouter and SERP API